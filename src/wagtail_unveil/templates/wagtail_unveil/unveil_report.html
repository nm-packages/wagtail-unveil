{% extends 'wagtailadmin/reports/base_report.html' %}

{% block extra_js %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            var checkUrlsButton = document.querySelectorAll('[data-action="check-urls"]')[0];
            var checkUrls = document.querySelectorAll('[data-check]');

            if (!checkUrlsButton) {
                return;
            }

            checkUrlsButton.addEventListener('click', function(event) {
                event.preventDefault();

                // Disable the button while checking
                checkUrlsButton.setAttribute('disabled', 'disabled');
                checkUrlsButton.innerText = 'Checking URLs...';

                let totalUrls = checkUrls.length;
                let checkedUrls = 0;
                let validUrls = 0;
                let invalidUrls = 0;

                // Check if there are URLs to check
                if (totalUrls === 0) {
                    alert('No URLs found to check.');
                    checkUrlsButton.removeAttribute('disabled');
                    checkUrlsButton.innerText = 'Check URLs';
                    return;
                }

                // Process each URL row
                checkUrls.forEach(function(row) {
                    const url = row.getAttribute('data-url');
                    const rowId = row.getAttribute('data-id');

                    if (!url) {
                        checkedUrls++;
                        invalidUrls++;
                        updateRowStatus(row, false, 'Missing URL');
                        checkIfCompleted();
                        return;
                    }

                    // Add a status cell if it doesn't exist
                    let statusCell = row.querySelector('.url-status');
                    if (!statusCell) {
                        statusCell = document.createElement('td');
                        statusCell.className = 'url-status';
                        row.appendChild(statusCell);
                    }

                    // Set status to checking
                    statusCell.innerHTML = '<span class="checking">Checking...</span>';

                    // Fetch the URL to check its status
                    fetch(url, { method: 'HEAD', mode: 'no-cors' })
                        .then(function(response) {
                            checkedUrls++;
                            if (response.ok) {
                                validUrls++;
                                updateRowStatus(row, true, 'Valid URL');
                            } else {
                                invalidUrls++;
                                updateRowStatus(row, false, 'Invalid URL: ' + response.status);
                            }
                            checkIfCompleted();
                        })
                        .catch(function(error) {
                            checkedUrls++;
                            invalidUrls++;
                            updateRowStatus(row, false, 'Error: ' + error.message);
                            checkIfCompleted();
                        });
                });

                // Function to update the status in the row
                function updateRowStatus(row, isValid, message) {
                    const statusCell = row.querySelector('.url-status');
                    if (statusCell) {
                        statusCell.innerHTML = isValid ?
                        '<span class="status-tag success">✓ ' + message + '</span>' :
                            '<span class="status-tag error">✗ ' + message + '</span>';
                    }

                    // Update row class to indicate status
                    if (isValid) {
                        row.classList.add('valid-url');
                        row.classList.remove('invalid-url');
                    } else {
                        row.classList.add('invalid-url');
                        row.classList.remove('valid-url');
                    }
                }

                // Function to check if all URLs have been verified
                function checkIfCompleted() {
                    if (checkedUrls >= totalUrls) {
                        // All URLs have been checked
                        checkUrlsButton.removeAttribute('disabled');
                        checkUrlsButton.innerText = 'Check URLs';

                        // Show a summary alert
                        alert('URL check completed.\n' +
                            'Total URLs: ' + totalUrls + '\n' +
                            'Valid URLs: ' + validUrls + '\n' +
                            'Invalid URLs: ' + invalidUrls);
                    }
                }
            });
        });
    </script>

    <style>
        .valid-url { background-color: rgba(0, 255, 0, 0.1); }
        .invalid-url { background-color: rgba(255, 0, 0, 0.1); }
        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        .status-tag.success { background-color: #dff0d8; color: #3c763d; }
        .status-tag.error { background-color: #f2dede; color: #a94442; }
        .checking { color: #777; font-style: italic; }
    </style>
{% endblock %}

