{% extends 'wagtailadmin/reports/base_report.html' %}

{% block extra_js %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            var checkUrlsButton = document.querySelectorAll('[data-action="check-urls"]')[0];
            var checkUrls = document.querySelectorAll('[data-check]');

            // Hide the success and error SVGs on page load, only show the empty radio button
            document.querySelectorAll('[data-result] .icon-circle-check, [data-result] .icon-error').forEach(svg => {
                svg.style.display = 'none';
            });

            if (!checkUrlsButton) {
                return;
            }

            checkUrlsButton.addEventListener('click', function(event) {
                event.preventDefault();

                // Disable the button while checking
                checkUrlsButton.setAttribute('disabled', 'disabled');
                checkUrlsButton.innerText = 'Checking URLs...';

                let totalUrls = checkUrls.length;
                let checkedUrls = 0;
                let validUrls = 0;
                let invalidUrls = 0;

                // Check if there are URLs to check
                if (totalUrls === 0) {
                    alert('No URLs found to check.');
                    checkUrlsButton.removeAttribute('disabled');
                    checkUrlsButton.innerText = 'Check URLs';
                    return;
                }

                // Process each URL row
                // Create a function to process URLs with delay
                function processUrlWithDelay(index) {
                    if (index >= checkUrls.length) {
                        return; // All URLs processed
                    }

                    const row = checkUrls[index];
                    const url = row.getAttribute('data-url');
                    const rowId = row.getAttribute('data-id');

                    if (!url) {
                        checkedUrls++;
                        invalidUrls++;
                        updateRowStatus(row, false, 'Missing URL');
                        checkIfCompleted();
                        // Process next URL after delay
                        setTimeout(() => processUrlWithDelay(index + 1), 100);
                        return;
                    }

                    // Set row to checking state
                    row.setAttribute('data-result', 'checking');

                    // Get the data-result cell and update SVG visibility for checking state
                    const resultCell = row.querySelector('[data-result]');
                    if (resultCell) {
                        resultCell.querySelectorAll('svg').forEach(svg => {
                            svg.style.display = 'none';
                        });
                        resultCell.querySelector('.icon-radio-empty').style.display = 'inline-block';
                    }

                    // Fetch the URL to check its status
                    fetch(url, { method: 'HEAD', mode: 'no-cors' })
                        .then(function(response) {
                            checkedUrls++;
                            if (response.ok) {
                                validUrls++;
                                updateRowStatus(row, true, 'Valid URL');
                            } else {
                                invalidUrls++;
                                updateRowStatus(row, false, 'Invalid URL: ' + response.status);
                            }
                            checkIfCompleted();
                            // Process next URL after delay
                            setTimeout(() => processUrlWithDelay(index + 1), 100);
                        })
                        .catch(function(error) {
                            checkedUrls++;
                            invalidUrls++;
                            updateRowStatus(row, false, 'Error: ' + error.message);
                            checkIfCompleted();
                            // Process next URL after delay
                            setTimeout(() => processUrlWithDelay(index + 1), 100);
                        });
                }

                // Start processing URLs with delay
                processUrlWithDelay(0);

                // Function to update the status in the row
                function updateRowStatus(row, isValid, message) {
                    // Get the data-result cell that contains the SVGs
                    const resultCell = row.querySelector('[data-result]');

                    if (resultCell) {
                        // Hide all SVG icons first
                        resultCell.querySelectorAll('svg').forEach(svg => {
                            svg.style.display = 'none';
                        });

                        // Show the appropriate SVG based on the result
                        if (isValid) {
                            resultCell.querySelector('.icon-circle-check').style.display = 'inline-block';
                        } else {
                            resultCell.querySelector('.icon-error').style.display = 'inline-block';
                        }
                    }

                    // Update data-result attribute on the row
                    row.setAttribute('data-result', isValid ? 'valid' : 'invalid');
                }

                // Function to check if all URLs have been verified
                function checkIfCompleted() {
                    if (checkedUrls >= totalUrls) {
                        // All URLs have been checked
                        checkUrlsButton.removeAttribute('disabled');
                        checkUrlsButton.innerText = 'Check URLs';
                    }
                }
            });
        });
    </script>

    <style>
        /* Just keeping Wagtail's default styles */
    </style>
{% endblock %}

